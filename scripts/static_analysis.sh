#!/bin/bash

# files to exclude based on file content
excludeContent="^// DO NOT EDIT|^// File generated by|^// Code generated by|^// Automatically generated"
filesToExclude=$(echo $(echo $(grep -lrE "$excludeContent" | grep '\.go' | fgrep -v vendor/ | sed -e "s/$/|/g") | sed -e "s/| /|/g") | sed -e "s/|$//g")

# linters to run based on parameters of this script
enabledLinters=""
for linterName in $*;
do
  enabledLinters="$enabledLinters --enable=$linterName"
done

params=-tags="${GO_BUILD_TAGS}"

# running linters (excluding vendor,...)
gometalinter \
	--vendor \
	--linter="vet:go vet ${params}:^(?:vet:.*?\.go:\s+(?P<path>.*?\.go):(?P<line>\d+):(?P<col>\d+):\s*(?P<message>.*))|(?:(?P<path>.*?\.go):(?P<line>\d+):\s*(?P<message>.*))$" \
	--deadline 3m \
	--enable-gc \
	--disable-all $enabledLinters \
	--exclude="should not use dot imports" \
	--exclude="don't use an underscore in package name" \
	--exclude="comment" \
	--exclude="returns unexported" \
	--exclude="block ends with a return statement" \
	./...
